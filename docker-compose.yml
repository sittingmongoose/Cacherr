# ===========================================
# Docker Compose Configuration for Cacherr
# Production-ready with profiles for different environments
# ===========================================

version: '3.8'

services:
  # ===========================================
  # PRODUCTION SERVICE
  # ===========================================
  cacherr:
    build:
      context: .
      dockerfile: Dockerfile
    image: sittingmongoose/cacherr:latest
    container_name: cacherr-prod
    restart: unless-stopped
    profiles: ["production"]
    env_file:
      - .env
    ports:
      - "5445:5445"  # Web interface and API
    environment:
      # Minimal environment variables - prefer web UI configuration
      - CACHERR_ENVIRONMENT=production
      - CACHERR_LOG_LEVEL=${LOG_LEVEL:-INFO}
      - TZ=${TZ:-UTC}
      # Legacy support (will be removed in future)
      - PLEX_URL=${PLEX_URL:-}
      - PLEX_TOKEN=${PLEX_TOKEN:-}
    volumes:
      # Configuration (persistent settings)
      - ${CONFIG_DIR:-./config}:/config:rw

      # Cache destination for media files
      - ${CACHE_DESTINATION:-./cache}:/cache:rw

      # Media sources (Unraid-specific paths)
      - /mnt/user/Media:/media:rw
      - /mnt/remotes/NAS1_Media2:/remote-media:rw
    networks:
      - cacherr-network
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5445/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 512M  # Reduced for production efficiency
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.25'

  # ===========================================
  # DEVELOPMENT SERVICE
  # ===========================================
  cacherr-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    image: sittingmongoose/cacherr:dev
    container_name: cacherr-dev
    restart: unless-stopped
    profiles: ["development"]
    env_file:
      - .env
    ports:
      - "5445:5445"  # Backend API
      - "3000:3000"  # Frontend dev server (hot reloading)
    environment:
      # Development-specific settings
      - CACHERR_ENVIRONMENT=development
      - CACHERR_DEBUG=true
      - CACHERR_LOG_LEVEL=DEBUG
      - TZ=${TZ:-UTC}

      # Legacy environment variables for compatibility
      - PLEX_URL=${PLEX_URL:-}
      - PLEX_TOKEN=${PLEX_TOKEN:-}
      - CONFIG_DIR=${CONFIG_DIR:-/config}
      - CACHE_DESTINATION=${CACHE_DESTINATION:-/cache}
    volumes:
      # Mount source code for hot reloading
      - ./src:/app/src:rw
      - ./main.py:/app/main.py:rw
      - ./requirements.txt:/app/requirements.txt:rw

      # Frontend hot reloading
      - ./frontend:/app/frontend:rw
      - /app/frontend/node_modules  # Named volume for node_modules

      # Configuration and data
      - ${CONFIG_DIR:-./config}:/config:rw
      - ${CACHE_DESTINATION:-./cache}:/cache:rw

      # Media sources
      - /mnt/user/Media:/media:rw
      - /mnt/remotes/NAS1_Media2:/remote-media:rw
    networks:
      - cacherr-network
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5445/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================
  # TESTING SERVICE (Playwright)
  # ===========================================
  cacherr-test:
    build:
      context: .
      dockerfile: Dockerfile.test
    image: sittingmongoose/cacherr:test
    container_name: cacherr-test
    profiles: ["testing"]
    environment:
      - CI=true
      - CACHERR_ENVIRONMENT=testing
    volumes:
      # Mount test files
      - ./e2e:/app/e2e:rw
      - ./playwright.config.js:/app/playwright.config.js:rw
      - ./playwright-report:/app/playwright-report:rw

      # Configuration for tests
      - ${CONFIG_DIR:-./config}:/config:rw
    networks:
      - cacherr-network
    working_dir: /app
    command: npx playwright test
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================
  # PLAYWRIGHT UI SERVICE (Interactive Testing)
  # ===========================================
  playwright-ui:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: cacherr-playwright-ui
    profiles: ["testing"]
    ports:
      - "9323:9323"  # Playwright UI port
    environment:
      - CI=false
    volumes:
      # Mount test files
      - ./e2e:/app/e2e:rw
      - ./playwright.config.js:/app/playwright.config.js:rw
      - ./playwright-report:/app/playwright-report:rw
    networks:
      - cacherr-network
    working_dir: /app
    command: npx playwright test --ui --ui-host=0.0.0.0
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  cacherr-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# ===========================================
# USAGE EXAMPLES
# ===========================================
#
# Production deployment:
#   docker-compose --profile production up -d
#
# Development with hot reloading:
#   docker-compose --profile development up
#
# Run tests:
#   docker-compose --profile testing up cacherr-test
#
# Interactive testing:
#   docker-compose --profile testing up playwright-ui
#
# Stop all services:
#   docker-compose --profile production,development,testing down

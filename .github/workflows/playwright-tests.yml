name: Playwright Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - critical
          - dashboard
          - settings
          - navigation
          - responsive
          - accessibility
          - performance

jobs:
  test:
    name: 'Playwright Tests'
    runs-on: ubuntu-latest
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox]
        shard: [1/2, 2/2]
        include:
          - browser: webkit
            shard: 1/1

    services:
      # Backend API service
      backend:
        image: python:3.11-slim
        ports:
          - 5445:5445
        env:
          CACHERR_ENVIRONMENT: testing
          PYTHONPATH: /app/src
        volumes:
          - ${{ github.workspace }}/src:/app/src
          - ${{ github.workspace }}/main.py:/app/main.py
          - ${{ github.workspace }}/requirements.txt:/app/requirements.txt
        working_dir: /app
        command: >
          bash -c "
            pip install -r requirements.txt &&
            python main.py --host 0.0.0.0 --port 5445
          "
        options: >-
          --health-cmd "curl -f http://localhost:5445/api/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: package-lock.json

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y curl ca-certificates

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install Node.js dependencies
      run: npm ci

    - name: Install Playwright browsers
      run: npx playwright install --with-deps

    - name: Build frontend
      run: |
        cd frontend
        npm ci
        npm run build

    - name: Wait for backend to be ready
      run: |
        timeout 60 bash -c 'until curl -f http://localhost:5445/api/health; do sleep 2; done'
        echo "Backend is ready!"

    - name: Run Playwright tests
      run: |
        if [ "${{ inputs.test_type }}" = "all" ] || [ -z "${{ inputs.test_type }}" ]; then
          npx playwright test --project=${{ matrix.browser }} --shard=${{ matrix.shard }}
        else
          npx playwright test --project=${{ matrix.browser }} --shard=${{ matrix.shard }} --grep "${{ inputs.test_type }}"
        fi

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.browser }}-${{ matrix.shard }}
        path: test-results/
        retention-days: 30

    - name: Upload test reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report-${{ matrix.browser }}-${{ matrix.shard }}
        path: playwright-report/
        retention-days: 30

    - name: Generate test summary
      if: always()
      run: |
        echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Browser:** ${{ matrix.browser }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Shard:** ${{ matrix.shard }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

        if [ -f "test-results/results.json" ]; then
          echo "### Test Statistics" >> $GITHUB_STEP_SUMMARY
          jq -r '
            "Passed: \(.passed)",
            "Failed: \(.failed)",
            "Skipped: \(.skipped)",
            "Duration: \(.duration)ms"
          ' test-results/results.json >> $GITHUB_STEP_SUMMARY
        fi

  accessibility-test:
    name: 'Accessibility Tests'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright
      run: npx playwright install --with-deps chromium

    - name: Build frontend
      run: |
        cd frontend
        npm ci
        npm run build

    - name: Run accessibility tests
      run: npx playwright test --project=accessibility --grep "accessibility"

    - name: Upload accessibility report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: accessibility-report
        path: playwright-report/
        retention-days: 30

  performance-test:
    name: 'Performance Tests'
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright
      run: npx playwright install --with-deps chromium

    - name: Build frontend
      run: |
        cd frontend
        npm ci
        npm run build

    - name: Run performance tests
      run: npx playwright test --grep "performance"

    - name: Upload performance results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-results
        path: test-results/
        retention-days: 30

  mobile-test:
    name: 'Mobile Tests'
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright
      run: npx playwright install --with-deps

    - name: Build frontend
      run: |
        cd frontend
        npm ci
        npm run build

    - name: Run mobile tests
      run: |
        npx playwright test --project=mobile-chrome
        npx playwright test --project=mobile-safari

    - name: Upload mobile test results
      uses: actions/upload-artifact@v4
      if: always()
        with:
          name: mobile-test-results
          path: test-results/
          retention-days: 30

  report:
    name: 'Generate Test Report'
    runs-on: ubuntu-latest
    needs: [test, accessibility-test, performance-test, mobile-test]
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download test results
      uses: actions/download-artifact@v4
      with:
        path: ./all-test-results

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright
      run: npx playwright install --with-deps chromium

    - name: Merge test results
      run: npx playwright merge-reports ./all-test-results

    - name: Upload merged report
      uses: actions/upload-artifact@v4
      with:
        name: final-test-report
        path: playwright-report/
        retention-days: 60

    - name: Generate summary report
      run: |
        echo "## ðŸŽ­ Playwright Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Overall status
        if [ "${{ needs.test.result }}" = "success" ] && \
           [ "${{ needs.accessibility-test.result }}" = "success" ] && \
           [ "${{ needs.performance-test.result }}" = "success" ] && \
           [ "${{ needs.mobile-test.result }}" = "success" ]; then
          echo "âœ… **All tests passed!**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Some tests failed**" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Suite Results" >> $GITHUB_STEP_SUMMARY
        echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Main Tests | ${{ needs.test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Accessibility | ${{ needs.accessibility-test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Performance | ${{ needs.performance-test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Mobile | ${{ needs.mobile-test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Test Report" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ˆ [View Detailed Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“‹ [Test Results](./all-test-results)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“Š [HTML Report](./playwright-report/index.html)" >> $GITHUB_STEP_SUMMARY

  notify:
    name: 'Notify on Failure'
    runs-on: ubuntu-latest
    needs: [test, report]
    if: failure() && github.ref == 'refs/heads/main'

    steps:
    - name: Notify Slack
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: |
          ðŸš¨ *Cacherr Test Suite Failed*

          Branch: `${{ github.ref_name }}`
          Commit: `${{ github.sha }}`
          Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Failed test suites: ${{ needs.test.result != 'success' && 'Main Tests' || '' }} ${{ needs.accessibility-test.result != 'success' && 'Accessibility' || '' }} ${{ needs.performance-test.result != 'success' && 'Performance' || '' }} ${{ needs.mobile-test.result != 'success' && 'Mobile' || '' }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      if: env.SLACK_WEBHOOK_URL != null

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .error { color: red; background: #ffe6e6; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .success { color: green; background: #e6ffe6; padding: 10px; border-radius: 4px; margin: 10px 0; }
        #console-output { background: #f5f5f5; padding: 10px; border-radius: 4px; margin: 10px 0; white-space: pre-wrap; font-family: monospace; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>PlexCacheUltra Debug Test</h1>
    
    <h2>API Tests</h2>
    <button onclick="testAPI()">Test API Health</button>
    <button onclick="testStatus()">Test Status Endpoint</button>
    <div id="api-results"></div>
    
    <h2>JavaScript Console Output</h2>
    <div id="console-output"></div>
    
    <h2>React App Debug</h2>
    <button onclick="testReactImports()">Test React Imports</button>
    <div id="react-debug"></div>
    
    <h2>Main App Test</h2>
    <button onclick="loadMainApp()">Load Main App (in iframe)</button>
    <div id="main-app-test">
        <iframe id="app-iframe" style="width: 100%; height: 400px; border: 1px solid #ccc; display: none;"></iframe>
    </div>

    <script>
        // Capture console errors
        const consoleOutput = document.getElementById('console-output');
        const originalError = console.error;
        console.error = function(...args) {
            originalError.apply(console, arguments);
            consoleOutput.textContent += '[ERROR] ' + args.join(' ') + '\n';
        };
        
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, arguments);
            consoleOutput.textContent += '[LOG] ' + args.join(' ') + '\n';
        };
        
        // Capture unhandled errors
        window.addEventListener('error', function(event) {
            consoleOutput.textContent += '[UNHANDLED ERROR] ' + event.error + '\n' + event.error.stack + '\n';
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            consoleOutput.textContent += '[UNHANDLED PROMISE REJECTION] ' + event.reason + '\n';
        });

        async function testAPI() {
            const results = document.getElementById('api-results');
            try {
                const response = await fetch('/health');
                const data = await response.json();
                results.innerHTML = '<div class="success">Health API OK: ' + JSON.stringify(data, null, 2) + '</div>';
            } catch (error) {
                results.innerHTML = '<div class="error">Health API Error: ' + error.message + '</div>';
            }
        }
        
        async function testStatus() {
            const results = document.getElementById('api-results');
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                results.innerHTML += '<div class="success">Status API Response: ' + JSON.stringify(data, null, 2) + '</div>';
            } catch (error) {
                results.innerHTML += '<div class="error">Status API Error: ' + error.message + '</div>';
            }
        }
        
        async function testReactImports() {
            const results = document.getElementById('react-debug');
            try {
                // Try to load the main React module
                const module = await import('/assets/index-c6ed6899.js');
                results.innerHTML = '<div class="success">React module loaded successfully: ' + Object.keys(module).join(', ') + '</div>';
            } catch (error) {
                results.innerHTML = '<div class="error">React module import error: ' + error.message + '</div>';
                consoleOutput.textContent += '[REACT IMPORT ERROR] ' + error.message + '\n' + error.stack + '\n';
            }
        }
        
        function loadMainApp() {
            const iframe = document.getElementById('app-iframe');
            iframe.style.display = 'block';
            iframe.src = '/app';
            
            iframe.onload = function() {
                console.log('Main app loaded in iframe');
                // Try to detect errors in the iframe
                setTimeout(() => {
                    try {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        const errorElements = iframeDoc.querySelectorAll('h1');
                        for (let el of errorElements) {
                            if (el.textContent.includes('Something went wrong')) {
                                consoleOutput.textContent += '[IFRAME] Error detected: Something went wrong\n';
                            }
                        }
                    } catch (e) {
                        consoleOutput.textContent += '[IFRAME] Cannot access iframe content: ' + e.message + '\n';
                    }
                }, 1000);
            };
            
            iframe.onerror = function() {
                consoleOutput.textContent += '[IFRAME] Failed to load main app\n';
            };
        }
        
        // Auto-run some tests
        console.log('Debug page loaded, running initial tests...');
        testAPI();
    </script>
</body>
</html>